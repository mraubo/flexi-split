---
import AuthLayout from "@/layouts/AuthLayout.astro";
import ResetPasswordForm from "@/components/auth/ResetPasswordForm";

// Redirect authenticated users to settlements
if (Astro.locals.user) {
  return Astro.redirect("/settlements");
}

// Handle password reset session establishment
const url = new URL(Astro.request.url);
const code = url.searchParams.get("code");
const type = url.searchParams.get("type");

// If we have a recovery code, exchange it for a session
if (code && type === "recovery") {
  try {
    const { data, error } = await Astro.locals.supabase.auth.exchangeCodeForSession(code);

    if (error) {
      // Invalid or expired code - redirect to forgot password
      return Astro.redirect("/auth/forgot-password?error=invalid_reset_link");
    }

    if (data.session) {
      // Session established successfully - continue to render form
      // The middleware will pick up the new session on the next request
    }
  } catch {
    // Handle unexpected errors
    return Astro.redirect("/auth/forgot-password?error=reset_error");
  }
} else if (code || type) {
  // Invalid parameters
  return Astro.redirect("/auth/forgot-password?error=invalid_reset_link");
}
---

<AuthLayout title="Ustawienie nowego hasÅ‚a - FlexiSplit">
  <ResetPasswordForm client:load />
</AuthLayout>
