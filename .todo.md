# Flex-Split Production Readiness TODO

## Overview

This document tracks tasks that need to be completed before deploying to production and after implementing full authentication.

## Current Development State

- ✅ RLS (Row Level Security) is DISABLED on all tables for development
- ✅ Authentication is mocked in middleware
- ✅ Participant creation uses direct TypeScript logic instead of stored procedures
- ✅ Cookie management is simplified for development

## Production Readiness Checklist

### 1. Enable Row Level Security (RLS) on All Tables

RLS is currently disabled for development. Before production, enable RLS on all tables:

```sql
ALTER TABLE public.settlements ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.participants ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.expenses ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.expense_participants ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.settlement_snapshots ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.events ENABLE ROW LEVEL SECURITY;
```

### 2. Create Security Policies for RLS

After enabling RLS, create policies for each table to ensure users can only access their own data:

- **Settlements table**: Users can only see settlements where they are the owner (`owner_id = auth.uid()`)
- **Participants table**: Users can only see participants in settlements they own or participate in
- **Expenses table**: Users can only see expenses in settlements they participate in
- **Expense_participants table**: Users can only see expense participations they're involved in

### 3. Review and Restore Stored Procedures

Consider whether to restore the original `create_participant_with_settlement_update` stored procedure:

- **Pros**: Atomic transactions, better performance, centralized business logic
- **Cons**: Harder to debug, depends on auth context
- **Alternative**: Keep TypeScript implementation for better maintainability

If restoring stored procedures, ensure they properly use `auth.uid()` instead of accepting `user_id` parameters.

### 4. Update Middleware for Production

Restore proper session and cookie management:

- Implement proper cookie handling instead of the simplified version
- Add JWT token validation and refresh logic
- Remove mock user injection
- Add proper error handling for authentication failures

### 5. Security Testing

Thoroughly test all security restrictions:

- ✅ Users cannot see other users' settlements
- ✅ Only settlement owners can add participants
- ✅ Only settlement participants can add expenses
- ✅ Closed settlements cannot be modified
- ✅ Soft-deleted settlements are not accessible
- ✅ Users cannot modify records they don't own

### 6. Verify All API Endpoints

Ensure all endpoints properly enforce authentication and authorization:

- `GET /api/settlements` - returns only user's settlements
- `POST /api/settlements/[id]/participants` - only settlement owner
- `POST /api/settlements/[id]/expenses` - only settlement participants
- All endpoints should use real `user.id` from JWT token, not mock data

### 7. Database Migration Strategy

Plan how to handle the transition from development to production:

- Create migration to enable RLS on existing data
- Ensure existing data has proper `owner_id` and `last_edited_by` values
- Test data integrity after enabling RLS
- Consider data cleanup for any test/mock data

### 8. Authentication Integration

After implementing full Supabase Auth:

- Remove mock user from middleware
- Update all service functions to use real `user.id`
- Test login/logout flows
- Verify JWT token handling
- Test session persistence and refresh

### 9. Performance Considerations

- Review database indexes after enabling RLS
- Test query performance with security policies
- Consider caching strategies for frequently accessed data
- Monitor database performance after production deployment

### 10. Monitoring and Logging

Set up proper monitoring for production:

- Add authentication failure logging
- Monitor for unauthorized access attempts
- Set up alerts for security-related events
- Implement audit logging for sensitive operations

## Priority Order

1. **High Priority**: Enable RLS and create basic policies
2. **High Priority**: Implement proper authentication
3. **Medium Priority**: Security testing and API verification
4. **Medium Priority**: Middleware updates
5. **Low Priority**: Performance optimization and monitoring

## Testing Checklist

- [ ] Create test users and settlements
- [ ] Verify users can't access others' data
- [ ] Test all CRUD operations with proper permissions
- [ ] Verify stored procedures work with real auth
- [ ] Test session handling and token refresh
- [ ] Load testing with multiple concurrent users

### 11. Implement Error Handling for Authentication

After implementing full Supabase Auth, add proper error handling for authentication failures:

- Add middleware logic to catch 401/403 errors and redirect to appropriate error pages
- Implement session expiry detection and automatic redirects
- Add proper error boundaries for authentication state changes
- Create error pages that preserve intended destination URLs
- Test error handling with expired sessions and invalid tokens

## Rollback Plan

If issues arise after production deployment:

1. **Immediate rollback**: Disable RLS temporarily
2. **Gradual rollback**: Keep RLS but loosen policies
3. **Data integrity check**: Ensure no data corruption occurred
4. **User communication**: Inform users of temporary issues

---

### 11. Telemetry events for summary view

After implementing the summary view, add telemetry event emission:

- `settle_confirmed` - after confirming settlement closure in modal
- `settled` - after successful closure with balances and transfers calculation
- `summary_copied` - after copying summary to clipboard

Events should be emitted by API endpoints according to existing EventDTO schema.

---

*Last updated: October 24, 2025*
